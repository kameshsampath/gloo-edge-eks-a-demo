
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://kameshsampath.github.io/gloo-edge-eks-a-demo/microservice/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.4">
    
    
      
        <title>Gloo Edge with Microservice - EKS-A Gloo Edge</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.f7f47774.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#deploy-app" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="EKS-A Gloo Edge" class="md-header__button md-logo" aria-label="EKS-A Gloo Edge" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EKS-A Gloo Edge
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Gloo Edge with Microservice
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="EKS-A Gloo Edge" class="md-nav__button md-logo" aria-label="EKS-A Gloo Edge" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    EKS-A Gloo Edge
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../blog/" class="md-nav__link">
        Gloo Edge on EKS-A in 5 minutes
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        Tutorial
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Tutorial" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Tutorial
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../setup/" class="md-nav__link">
        Setup
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../lambda/" class="md-nav__link">
        Gloo Edge with AWS Lambda
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Gloo Edge with Microservice
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Gloo Edge with Microservice
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deploy-database" class="md-nav__link">
    Deploy Database
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-rest-api" class="md-nav__link">
    Deploy REST API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gloo-edge" class="md-nav__link">
    Gloo Edge
  </a>
  
    <nav class="md-nav" aria-label="Gloo Edge">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#upstreams" class="md-nav__link">
    Upstreams
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#route" class="md-nav__link">
    Route
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#invoke-api" class="md-nav__link">
    Invoke API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rate-limit" class="md-nav__link">
    Rate Limit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#web-application-firewall" class="md-nav__link">
    Web Application Firewall
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cors" class="md-nav__link">
    CORS
  </a>
  
    <nav class="md-nav" aria-label="CORS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#build-the-ui-application" class="md-nav__link">
    Build the UI Application
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-virtual-service" class="md-nav__link">
    Update Virtual Service
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deploy-database" class="md-nav__link">
    Deploy Database
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-rest-api" class="md-nav__link">
    Deploy REST API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gloo-edge" class="md-nav__link">
    Gloo Edge
  </a>
  
    <nav class="md-nav" aria-label="Gloo Edge">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#upstreams" class="md-nav__link">
    Upstreams
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#route" class="md-nav__link">
    Route
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#invoke-api" class="md-nav__link">
    Invoke API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rate-limit" class="md-nav__link">
    Rate Limit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#web-application-firewall" class="md-nav__link">
    Web Application Firewall
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cors" class="md-nav__link">
    CORS
  </a>
  
    <nav class="md-nav" aria-label="CORS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#build-the-ui-application" class="md-nav__link">
    Build the UI Application
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-virtual-service" class="md-nav__link">
    Update Virtual Service
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="deploy-app">Deploy App<a class="headerlink" href="#deploy-app" title="Permanent link">&para;</a></h1>
<p>The demo application that will be deployed is a simple Fruits microservice. The source code the Fruits API is available <a href="https://github.com/kameshsampath/gloo-edge-eks-a-demo" target="blank">here</a>.</p>
<p>At the end of this chapter you would have known how to:</p>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Create Gloo Edge Gateway</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Configure Rate Limiting</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Configure <abbr title="Web Application Firewall">WAF</abbr></li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Configure <abbr title="Cross-Origin Resource Sharing">CORS</abbr></li>
</ul>
<h2 id="deploy-database">Deploy Database<a class="headerlink" href="#deploy-database" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>kubectl apply -k <span class="nv">$DEMO_HOME</span>/apps/microservice/fruits-api/db
</code></pre></div>
<p>Wait for the DB to be up</p>
<div class="highlight"><pre><span></span><code>kubectl rollout status -n db deploy/postgresql --timeout<span class="o">=</span>60s
</code></pre></div>
<mark class="critic block">
<p>Waiting for deployment &ldquo;postgresql&rdquo; rollout to finish: 0 of 1 updated replicas are available&hellip;</p>
<p>deployment &ldquo;postgresql&rdquo; successfully rolled out</p>
</mark>
<h2 id="deploy-rest-api">Deploy <abbr title="Representational state transfer">REST</abbr> API<a class="headerlink" href="#deploy-rest-api" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>kubectl apply -k <span class="nv">$DEMO_HOME</span>/apps/microservice/fruits-api/app
</code></pre></div>
<p>Wait for the <abbr title="Representational state transfer">REST</abbr> API to be up</p>
<div class="highlight"><pre><span></span><code>kubectl rollout status -n fruits-app deploy/fruits-api --timeout<span class="o">=</span>60s
</code></pre></div>
<mark class="critic block">
<p>Waiting for deployment &ldquo;fruits-api&rdquo; rollout to finish: 0 of 1 updated replicas are available&hellip;</p>
<p>deployment &ldquo;fruits-api&rdquo; successfully rolled out</p>
</mark>
<h2 id="gloo-edge">Gloo Edge<a class="headerlink" href="#gloo-edge" title="Permanent link">&para;</a></h2>
<p>We have now deployed the Fruits API, in the up coming sections we will create the necessary Gloo Edge resources that will allow configure and access the API. To have more understanding on the core concepts check the <a href="https://docs.solo.io/gloo-edge/latest/introduction/traffic_management/" target="_blank">Traffic Management</a> documentation.</p>
<p>In the upcoming sections we will,</p>
<ul>
<li><a href="https://docs.solo.io/gloo-edge/latest/introduction/architecture/concepts/#upstreams" target="_blank">Discover Upstreams</a></li>
<li><a href="https://docs.solo.io/gloo-edge/latest/introduction/architecture/concepts/#virtual-services" target="_blank">Create Virtual Services</a></li>
</ul>
<h3 id="upstreams">Upstreams<a class="headerlink" href="#upstreams" title="Permanent link">&para;</a></h3>
<p>The Gloo Edge installation that as done as part of the demo is enabled to do auto discovery of the upstreams. The Fruits API that we deployed earlier would have been discovered as <code>fruits-app-fruits-api-8080</code>.</p>
<p>Let us check to see if thats available,</p>
<div class="highlight"><pre><span></span><code>glooctl get upstream fruits-app-fruits-api-8080
</code></pre></div>
<div class="highlight"><pre><span></span><code>-----------------------------------------------------------------------------+
|          UPSTREAM          |    TYPE    |  STATUS  |          DETAILS          |
-----------------------------------------------------------------------------+
| fruits-app-fruits-api-8080 | Kubernetes | Accepted | svc name:      fruits-api |
|                            |            |          | svc namespace: fruits-app |
|                            |            |          | port:          8080       |
|                            |            |          |                           |
-----------------------------------------------------------------------------+
</code></pre></div>
<h3 id="route">Route<a class="headerlink" href="#route" title="Permanent link">&para;</a></h3>
<p>A Route is a Gloo Virutal Service resource that allows us to access the API i.e. the services that are deployed on to Kubernetes.</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gateway.solo.io/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">VirtualService</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fruits-api</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gloo-system</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">displayName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">FruitsAPI</span>
  <span class="nt">virtualHost</span><span class="p">:</span>
    <span class="nt">domains</span><span class="p">:</span> <span class="c1"># (1)</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;*&quot;</span>
    <span class="nt">routes</span><span class="p">:</span>
      <span class="c1"># Application Routes</span>
      <span class="c1"># ------------</span>
      <span class="p p-Indicator">-</span> <span class="nt">matchers</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">prefix</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/api/</span> <span class="c1">#(2)</span>
        <span class="nt">routeAction</span><span class="p">:</span>
          <span class="nt">single</span><span class="p">:</span>
            <span class="nt">upstream</span><span class="p">:</span> <span class="c1">#(3)</span>
              <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fruits-app-fruits-api-8080</span>
              <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gloo-system</span>
        <span class="nt">options</span><span class="p">:</span>
          <span class="nt">prefixRewrite</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/v1/api/</span> <span class="c1">#(4)</span>
</code></pre></div>
<ol>
<li>Domains that will be allowed by the Gateway</li>
<li>The prefix to access the API</li>
<li>The upstream that wil be used to route the request</li>
<li>The url rewrite to do before passing the request to backend</li>
</ol>
<p>Let us create the virutal service,</p>
<div class="highlight"><pre><span></span><code>kubectl apply -n gloo-system -f <span class="nv">$DEMO_HOME</span>/apps/microservice/fruits-api/gloo/virtual-service.yaml
</code></pre></div>
<p>Check the status of the virtual service</p>
<div class="highlight"><pre><span></span><code>glooctl get vs fruits-api
</code></pre></div>
<div class="highlight"><pre><span></span><code>----------------------------------------------------------------------------------------------
| VIRTUAL SERVICE | DISPLAY NAME | DOMAINS | SSL  |  STATUS  | LISTENERPLUGINS |       ROUTES        |
----------------------------------------------------------------------------------------------
| fruits-api      |              | *       | none | Accepted |                 | / -&gt; 1 destinations |
----------------------------------------------------------------------------------------------
</code></pre></div>
<h2 id="invoke-api">Invoke API<a class="headerlink" href="#invoke-api" title="Permanent link">&para;</a></h2>
<p>We need to use the Gloo proxy to access the API, we can use glooctl to get the proxy URL,</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">GLOO_PROXY_URL</span><span class="o">=</span><span class="k">$(</span>glooctl proxy url<span class="k">)</span>
</code></pre></div>
<p>Check if the API is accessible,</p>
<div class="highlight"><pre><span></span><code>http <span class="nv">$GLOO_PROXY_URL</span>/api/fruits/
</code></pre></div>
<p>The command should return a list of fruits as shown,</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span>
  <span class="p">{</span> <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Apple&quot;</span><span class="p">,</span> <span class="nt">&quot;season&quot;</span><span class="p">:</span> <span class="s2">&quot;Fall&quot;</span><span class="p">,</span> <span class="nt">&quot;emoji&quot;</span><span class="p">:</span> <span class="s2">&quot;U+1F34E&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Banana&quot;</span><span class="p">,</span> <span class="nt">&quot;season&quot;</span><span class="p">:</span> <span class="s2">&quot;Summer&quot;</span><span class="p">,</span> <span class="nt">&quot;emoji&quot;</span><span class="p">:</span> <span class="s2">&quot;U+1F34C&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Blueberry&quot;</span><span class="p">,</span> <span class="nt">&quot;season&quot;</span><span class="p">:</span> <span class="s2">&quot;Summer&quot;</span><span class="p">,</span> <span class="nt">&quot;emoji&quot;</span><span class="p">:</span> <span class="s2">&quot;U+1FAD0&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Lemon&quot;</span><span class="p">,</span> <span class="nt">&quot;season&quot;</span><span class="p">:</span> <span class="s2">&quot;Winter&quot;</span><span class="p">,</span> <span class="nt">&quot;emoji&quot;</span><span class="p">:</span> <span class="s2">&quot;U+1F34B&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Mango&quot;</span><span class="p">,</span> <span class="nt">&quot;season&quot;</span><span class="p">:</span> <span class="s2">&quot;Spring&quot;</span><span class="p">,</span> <span class="nt">&quot;emoji&quot;</span><span class="p">:</span> <span class="s2">&quot;U+1F96D&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Orange&quot;</span><span class="p">,</span> <span class="nt">&quot;season&quot;</span><span class="p">:</span> <span class="s2">&quot;Winter&quot;</span><span class="p">,</span> <span class="nt">&quot;emoji&quot;</span><span class="p">:</span> <span class="s2">&quot;U+1F34A&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Pear&quot;</span><span class="p">,</span> <span class="nt">&quot;season&quot;</span><span class="p">:</span> <span class="s2">&quot;Fall&quot;</span><span class="p">,</span> <span class="nt">&quot;emoji&quot;</span><span class="p">:</span> <span class="s2">&quot;U+1F350&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Strawberry&quot;</span><span class="p">,</span> <span class="nt">&quot;season&quot;</span><span class="p">:</span> <span class="s2">&quot;Spring&quot;</span><span class="p">,</span> <span class="nt">&quot;emoji&quot;</span><span class="p">:</span> <span class="s2">&quot;U+1F353&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Watermelon&quot;</span><span class="p">,</span> <span class="nt">&quot;season&quot;</span><span class="p">:</span> <span class="s2">&quot;Summer&quot;</span><span class="p">,</span> <span class="nt">&quot;emoji&quot;</span><span class="p">:</span> <span class="s2">&quot;U+1F349&quot;</span> <span class="p">}</span>
<span class="p">]</span>
</code></pre></div>
<h2 id="rate-limit">Rate Limit<a class="headerlink" href="#rate-limit" title="Permanent link">&para;</a></h2>
<p>As part of this sectiobn we will configure <a href="https://en.wikipedia.org/wiki/Rate_limiting" targe="_blank">Rate limiting</a>.</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ratelimit.solo.io/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">RateLimitConfig</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">global-limit</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gloo-system</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">raw</span><span class="p">:</span>
    <span class="nt">descriptors</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">generic_key</span>
      <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">count</span>
      <span class="nt">rateLimit</span><span class="p">:</span>
        <span class="nt">requestsPerUnit</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span> <span class="c1">#(1)</span>
        <span class="nt">unit</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">MINUTE</span> <span class="c1">#(1)</span>
    <span class="nt">rateLimits</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">actions</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">genericKey</span><span class="p">:</span>
          <span class="nt">descriptorValue</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">count</span>
</code></pre></div>
<ol>
<li>Number of requests</li>
<li>The duration for the request threshold, is this case 1 minute</li>
</ol>
<p>Let us apply the rate limiting configuration,</p>
<div class="highlight"><pre><span></span><code>kubectl apply -n gloo-system -f <span class="nv">$DEMO_HOME</span>/apps/microservice/fruits-api/gloo/ratelimit-config.yaml
</code></pre></div>
<p>Update the service with ratelimit,</p>
<div class="highlight"><pre><span></span><code>kubectl apply -n gloo-system -f <span class="nv">$DEMO_HOME</span>/apps/microservice/fruits-api/gloo/virtual-service-ratelimit.yaml
</code></pre></div>
<p>Let us now send requests to the API, with our current configuration we should start to get <code>HTTP 429</code> once we exceed 10 requests,</p>
<div class="highlight"><pre><span></span><code><span class="nv">$DEMO_HOME</span>/bin/poll.sh
</code></pre></div>
<p>Wait for a minute more to try polling again to see the requests getting executed successfully.</p>
<h2 id="web-application-firewall">Web Application Firewall<a class="headerlink" href="#web-application-firewall" title="Permanent link">&para;</a></h2>
<p>A <abbr title="Web Application Firewall">WAF</abbr> protects web applications by monitoring, filtering and blocking potentially harmful traffic and attacks that can overtake or exploit them.</p>
<p>Gloo Edge Enterprise includes the ability to enable the ModSecurity <a href="https://docs.solo.io/gloo-edge/latest/guides/security/waf/" target="_blank">Web Application Firewall</a>for any incoming and outgoing HTTP connections.</p>
<p>For this demo, let us assume that our application does not support <em>Firefox</em> yet so for any requests that come with <em>Firefox</em> browser agent need to be blocked and informed.</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gateway.solo.io/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">VirtualService</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fruits-api</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gloo-system</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">displayName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">FruitsAPI</span>
  <span class="nt">virtualHost</span><span class="p">:</span>
    <span class="nt">options</span><span class="p">:</span>
      <span class="c1"># -------- Web Application Firewall - Check User-Agent  -----------</span>
      <span class="nt">waf</span><span class="p">:</span> <span class="c1"># (1)</span>
        <span class="nt">ruleSets</span><span class="p">:</span> <span class="c1"># (2)</span>
        <span class="p p-Indicator">-</span> <span class="nt">ruleStr</span><span class="p">:</span> <span class="p p-Indicator">|</span> <span class="c1"># (3)</span>
            <span class="no">SecRuleEngine On</span>
            <span class="no">SecRule REQUEST_HEADERS:User-Agent &quot;.*Firefox.*&quot; &quot;deny,status:403,id:107,phase:1,msg:&#39;unsupported user agent&#39;&quot; </span>
        <span class="nt">customInterventionMessage</span><span class="p">:</span> <span class="s">&quot;Firefox</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">supported&quot;</span> <span class="c1"># (4)</span>
    <span class="nt">domains</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;*&quot;</span>
    <span class="nt">routes</span><span class="p">:</span>
      <span class="c1"># --------------------- Application Routes -----------------</span>
      <span class="p p-Indicator">-</span> <span class="nt">matchers</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">prefix</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/api/</span>
        <span class="nt">routeAction</span><span class="p">:</span>
          <span class="nt">single</span><span class="p">:</span>
            <span class="nt">upstream</span><span class="p">:</span>
              <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fruits-app-fruits-api-8080</span>
              <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gloo-system</span>
        <span class="nt">options</span><span class="p">:</span>
          <span class="nt">prefixRewrite</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/v1/api/</span>
          <span class="c1"># ---------------- Rate limit config ----------------------</span>
          <span class="nt">rateLimitConfigs</span><span class="p">:</span>
            <span class="nt">refs</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">global-limit</span>
              <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gloo-system</span>
</code></pre></div>
<ol>
<li>Define <abbr title="Web Application Firewall">WAF</abbr> rules</li>
<li>The <abbr title="Web Application Firewall">WAF</abbr> block can have one or more <code>ruleSets</code></li>
<li>The rule inspects the <code>User-Agent</code> header</li>
<li>The message to display for rule voilations</li>
</ol>
<p>Let us update the Virtual Service with <abbr title="Web Application Firewall">WAF</abbr> enabled,</p>
<div class="highlight"><pre><span></span><code>kubectl apply -n gloo-system -f <span class="nv">$DEMO_HOME</span>/apps/microservice/fruits-api/gloo/virtual-service-waf.yaml
</code></pre></div>
<p>Try simulating the API request as if it was generated from <em>Firefox</em> browser:</p>
<div class="highlight"><pre><span></span><code>http <span class="nv">$GLOO_PROXY_URL</span>/api/fruits/ User-Agent:Firefox
</code></pre></div>
<p>The request should with a response,</p>
<div class="highlight"><pre><span></span><code><mark class="critic"> HTTP/1.1 403 Forbidden </mark>
content-length: 21
content-type: text/plain
date: Wed, 18 Aug 2021 11:24:46 GMT
server: envoy

<mark class="critic"> Firefox not supported </mark>
</code></pre></div>
<p>No try the same request with any other user agent which should succeed.</p>
<div class="highlight"><pre><span></span><code>http <span class="nv">$GLOO_PROXY_URL</span>/api/fruits/ User-Agent:Safari
</code></pre></div>
<h2 id="cors"><abbr title="Cross-Origin Resource Sharing">CORS</abbr><a class="headerlink" href="#cors" title="Permanent link">&para;</a></h2>
<p>Gloo Edge also supports configuring the <abbr title="Cross-Origin Resource Sharing">CORS</abbr> policies without the need to redeploy the backend API application. As part of this section we will extend our demo <code>Fruits API</code> with simple <abbr title="Single Page Application">SPA</abbr>.</p>
<h3 id="build-the-ui-application">Build the UI Application<a class="headerlink" href="#build-the-ui-application" title="Permanent link">&para;</a></h3>
<p>Since the <abbr title="Single Page Application">SPA</abbr> are accessed from browser we need to rebuild the UI with th <code>GLOO_PROXY_URL</code> that the application need to use,</p>
<div class="highlight"><pre><span></span><code>docker build --build-arg<span class="o">=</span><span class="s2">&quot;GLOO_PROXY_URL=</span><span class="nv">$GLOO_PROXY_URL</span><span class="s2">&quot;</span> <span class="se">\</span>
  -t example/fruits-ui <span class="se">\</span>
  -f <span class="nv">$DEMO_HOME</span>/Dockerfile-UI <span class="nv">$DEMO_HOME</span>
</code></pre></div>
<p>Once the contianer is built let us run it,</p>
<div class="highlight"><pre><span></span><code>docker run --rm -p <span class="m">8085</span>:8080 example/fruits-ui
</code></pre></div>
<p>When you open the <a href="http://localhost:8085">localhost:8085</a> in the browser you will see application page like</p>
<p><img alt="Fruits UI Loading" src="../images/fruits_ui_loading.png" /></p>
<p>When you open the browser&rsquo; developer tools console, you should notice the <abbr title="Cross-Origin Resource Sharing">CORS</abbr> errors like:</p>
<p><img alt="Fruits CORS Errors" src="../images/fruits_ui_cors.png" /></p>
<h3 id="update-virtual-service">Update Virtual Service<a class="headerlink" href="#update-virtual-service" title="Permanent link">&para;</a></h3>
<p>To fix this we need to update the Virutal Service with <abbr title="Cross-Origin Resource Sharing">CORS</abbr> options,</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gateway.solo.io/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">VirtualService</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fruits-api</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gloo-system</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">displayName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">FruitsAPI</span>
  <span class="nt">virtualHost</span><span class="p">:</span>
    <span class="nt">options</span><span class="p">:</span>
      <span class="c1"># -------- CORS Config  -----------</span>
      <span class="nt">cors</span><span class="p">:</span> <span class="c1"># (1)</span>
        <span class="nt">allowOriginRegex</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="s">&#39;^http(s)?:\/\/localhost:[0-9]{4,5}$&#39;</span> <span class="c1"># (2)</span>
        <span class="nt">allowHeaders</span><span class="p">:</span> <span class="c1"># (3)</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">origin</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">content-type</span>
        <span class="nt">allowMethods</span><span class="p">:</span> <span class="c1"># (4)</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DELETE</span>
        <span class="nt">maxAge</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1d</span>
      <span class="c1"># -------- Web Application Firewall - Check User-Agent  -----------</span>
      <span class="nt">waf</span><span class="p">:</span>
        <span class="nt">customInterventionMessage</span><span class="p">:</span> <span class="s">&quot;Firefox</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">supported&quot;</span>
        <span class="nt">ruleSets</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">ruleStr</span><span class="p">:</span> <span class="p p-Indicator">|</span>
              <span class="no">SecRuleEngine On</span>
              <span class="no">SecRule REQUEST_HEADERS:User-Agent &quot;.*Firefox.*&quot; &quot;deny,status:403,id:107,phase:1,msg:&#39;unsupported user agent&#39;&quot;</span>
    <span class="nt">domains</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;*&quot;</span>
    <span class="nt">routes</span><span class="p">:</span>
      <span class="c1"># --------------------- Application Routes -----------------</span>
      <span class="p p-Indicator">-</span> <span class="nt">matchers</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">prefix</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/api/</span>
        <span class="nt">routeAction</span><span class="p">:</span>
          <span class="nt">single</span><span class="p">:</span>
            <span class="nt">upstream</span><span class="p">:</span>
              <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fruits-app-fruits-api-8080</span>
              <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gloo-system</span>
        <span class="nt">options</span><span class="p">:</span>
          <span class="nt">prefixRewrite</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/v1/api/</span>
          <span class="c1"># ---------------- Rate limit config ----------------------</span>
          <span class="nt">rateLimitConfigs</span><span class="p">:</span>
            <span class="nt">refs</span><span class="p">:</span>
              <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">global-limit</span>
                <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gloo-system</span>
</code></pre></div>
<ol>
<li>Enable <abbr title="Cross-Origin Resource Sharing">CORS</abbr> options</li>
<li>The Origin Regular Expression, this will allow all <code>localhost</code></li>
<li>The <abbr title="Cross-Origin Resource Sharing">CORS</abbr> headers that are allowed</li>
<li>The methods that the orgins can excute</li>
</ol>
<p>Now let us update the virtual service,</p>
<div class="highlight"><pre><span></span><code>kubectl apply -n gloo-system -f <span class="nv">$DEMO_HOME</span>/apps/microservice/fruits-api/gloo/virtual-service-cors.yaml
</code></pre></div>
<p>Now try refreshing the browser url <a href="http://localhost:8085">localhost:8085</a> and you will see a list of fruits as shown without any <abbr title="Cross-Origin Resource Sharing">CORS</abbr> errors.</p>
<p><img alt="Fruits UI" src="../images/fruits_ui_loaded.png" /></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../lambda/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Gloo Edge with AWS Lambda" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Gloo Edge with AWS Lambda
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate", "content.tabs.link"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.709b4209.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.febc23d1.min.js"></script>
      
    
  </body>
</html>